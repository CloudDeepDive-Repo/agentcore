AWSTemplateFormatVersion: '2010-09-09'
Description: 'Network Troubleshooting Labs - All scenarios in one VPC with different subnets'

Parameters:
  LatestAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64'
    Description: 'Latest Amazon Linux 2023 AMI'

Resources:
  # ============================================================================
  # SHARED VPC INFRASTRUCTURE
  # ============================================================================
  
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: NetworkTroubleshootingVPC
        - Key: Project
          Value: NetworkTroubleshooting
        - Key: Auto-delete
          Value: 'no'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: NetworkTroubleshooting-IGW
        - Key: Project
          Value: NetworkTroubleshooting
        - Key: Auto-delete
          Value: 'no'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # ============================================================================
  # LAB 1: MISSING IGW ROUTE
  # ============================================================================
  
  Lab1Subnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Lab1-MissingIGWRoute-Subnet
        - Key: Lab
          Value: Lab1-MissingIGWRoute
        - Key: Auto-delete
          Value: 'no'

  Lab1RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Lab1-MissingIGWRoute-RouteTable
        - Key: Lab
          Value: Lab1-MissingIGWRoute
        - Key: Issue
          Value: 'No route to IGW'
        - Key: Auto-delete
          Value: 'no'

  # NOTE: Intentionally NOT creating route to IGW - this is the bug!
  
  Lab1SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref Lab1Subnet
      RouteTableId: !Ref Lab1RouteTable

  Lab1SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Lab1-MissingIGWRoute-SG
      GroupDescription: Security group for Lab 1
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: 'SSH access'
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: 'All outbound traffic'
      Tags:
        - Key: Name
          Value: Lab1-MissingIGWRoute-SG
        - Key: Lab
          Value: Lab1-MissingIGWRoute
        - Key: Auto-delete
          Value: 'no'

  Lab1Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro
      ImageId: !Ref LatestAmiId
      SubnetId: !Ref Lab1Subnet
      SecurityGroupIds:
        - !Ref Lab1SecurityGroup
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y curl wget
          
          cat > /home/ec2-user/test-connectivity.sh << 'EOF'
          #!/bin/bash
          echo "=== Lab 1: Missing IGW Route Test ==="
          echo "Testing Internet Connectivity..."
          echo ""
          echo "1. DNS resolution:"
          nslookup google.com
          echo ""
          echo "2. HTTP connectivity:"
          curl -I http://google.com --connect-timeout 5
          echo ""
          echo "3. HTTPS connectivity:"
          curl -I https://google.com --connect-timeout 5
          EOF
          
          chmod +x /home/ec2-user/test-connectivity.sh
          chown ec2-user:ec2-user /home/ec2-user/test-connectivity.sh
      Tags:
        - Key: Name
          Value: Lab1-MissingIGWRoute-Instance
        - Key: Lab
          Value: Lab1-MissingIGWRoute
        - Key: Issue
          Value: 'Route table missing 0.0.0.0/0 to IGW'
        - Key: Auto-delete
          Value: 'no'

  # ============================================================================
  # LAB 2: NO PUBLIC IP
  # ============================================================================
  
  Lab2Subnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false  # BUG: No auto-assign public IP
      Tags:
        - Key: Name
          Value: Lab2-NoPublicIP-Subnet
        - Key: Lab
          Value: Lab2-NoPublicIP
        - Key: Auto-delete
          Value: 'no'

  Lab2RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Lab2-NoPublicIP-RouteTable
        - Key: Lab
          Value: Lab2-NoPublicIP
        - Key: Auto-delete
          Value: 'no'

  Lab2Route:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref Lab2RouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  Lab2SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref Lab2Subnet
      RouteTableId: !Ref Lab2RouteTable

  Lab2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Lab2-NoPublicIP-SG
      GroupDescription: Security group for Lab 2
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: 'SSH access'
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: 'All outbound traffic'
      Tags:
        - Key: Name
          Value: Lab2-NoPublicIP-SG
        - Key: Lab
          Value: Lab2-NoPublicIP
        - Key: Auto-delete
          Value: 'no'

  Lab2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro
      ImageId: !Ref LatestAmiId
      SubnetId: !Ref Lab2Subnet
      SecurityGroupIds:
        - !Ref Lab2SecurityGroup
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y curl wget
          
          cat > /home/ec2-user/test-connectivity.sh << 'EOF'
          #!/bin/bash
          echo "=== Lab 2: No Public IP Test ==="
          echo "Testing Internet Connectivity..."
          echo ""
          echo "1. Check IP addresses:"
          ip addr show
          echo ""
          echo "2. DNS resolution:"
          nslookup google.com
          echo ""
          echo "3. HTTP connectivity:"
          curl -I http://google.com --connect-timeout 5
          EOF
          
          chmod +x /home/ec2-user/test-connectivity.sh
          chown ec2-user:ec2-user /home/ec2-user/test-connectivity.sh
      Tags:
        - Key: Name
          Value: Lab2-NoPublicIP-Instance
        - Key: Lab
          Value: Lab2-NoPublicIP
        - Key: Issue
          Value: 'Instance has no public IP address'
        - Key: Auto-delete
          Value: 'no'

  # ============================================================================
  # LAB 3: RESTRICTIVE SECURITY GROUP
  # ============================================================================
  
  Lab3Subnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Lab3-RestrictiveSG-Subnet
        - Key: Lab
          Value: Lab3-RestrictiveSG
        - Key: Auto-delete
          Value: 'no'

  Lab3RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Lab3-RestrictiveSG-RouteTable
        - Key: Lab
          Value: Lab3-RestrictiveSG
        - Key: Auto-delete
          Value: 'no'

  Lab3Route:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref Lab3RouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  Lab3SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref Lab3Subnet
      RouteTableId: !Ref Lab3RouteTable

  Lab3SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Lab3-RestrictiveSG-SG
      GroupDescription: Security group for Lab 3 - Only allows HTTPS egress
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: 'SSH access'
      SecurityGroupEgress:
        # BUG: Only allow HTTPS, block HTTP
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: 'HTTPS only - HTTP is blocked!'
      Tags:
        - Key: Name
          Value: Lab3-RestrictiveSG-SG
        - Key: Lab
          Value: Lab3-RestrictiveSG
        - Key: Issue
          Value: 'Security group only allows HTTPS egress'
        - Key: Auto-delete
          Value: 'no'

  Lab3Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro
      ImageId: !Ref LatestAmiId
      SubnetId: !Ref Lab3Subnet
      SecurityGroupIds:
        - !Ref Lab3SecurityGroup
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y curl wget
          
          cat > /home/ec2-user/test-connectivity.sh << 'EOF'
          #!/bin/bash
          echo "=== Lab 3: Restrictive Security Group Test ==="
          echo "Testing Internet Connectivity..."
          echo ""
          echo "1. HTTP connectivity (should fail):"
          curl -I http://google.com --connect-timeout 5
          echo ""
          echo "2. HTTPS connectivity (should work):"
          curl -I https://google.com --connect-timeout 5
          EOF
          
          chmod +x /home/ec2-user/test-connectivity.sh
          chown ec2-user:ec2-user /home/ec2-user/test-connectivity.sh
      Tags:
        - Key: Name
          Value: Lab3-RestrictiveSG-Instance
        - Key: Lab
          Value: Lab3-RestrictiveSG
        - Key: Issue
          Value: 'Security group blocks HTTP, only allows HTTPS'
        - Key: Auto-delete
          Value: 'no'

  # ============================================================================
  # LAB 4: NACL BLOCKING RETURN TRAFFIC
  # ============================================================================
  
  Lab4Subnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Lab4-NACLBlocking-Subnet
        - Key: Lab
          Value: Lab4-NACLBlocking
        - Key: Auto-delete
          Value: 'no'

  Lab4RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Lab4-NACLBlocking-RouteTable
        - Key: Lab
          Value: Lab4-NACLBlocking
        - Key: Auto-delete
          Value: 'no'

  Lab4Route:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref Lab4RouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  Lab4SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref Lab4Subnet
      RouteTableId: !Ref Lab4RouteTable

  Lab4NetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Lab4-NACLBlocking-NACL
        - Key: Lab
          Value: Lab4-NACLBlocking
        - Key: Issue
          Value: 'NACL blocks return traffic (ephemeral ports)'
        - Key: Auto-delete
          Value: 'no'

  # Allow inbound SSH
  Lab4NACLInboundSSH:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref Lab4NetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 22
        To: 22

  # Allow inbound ephemeral ports (for SSH return traffic)
  Lab4NACLInboundEphemeral:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref Lab4NetworkAcl
      RuleNumber: 110
      Protocol: 6
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 1024
        To: 65535

  # Allow outbound HTTPS
  Lab4NACLOutboundHTTPS:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref Lab4NetworkAcl
      RuleNumber: 100
      Protocol: 6
      Egress: true
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 443
        To: 443

  # Allow outbound HTTP
  Lab4NACLOutboundHTTP:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref Lab4NetworkAcl
      RuleNumber: 110
      Protocol: 6
      Egress: true
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 80
        To: 80

  # BUG: NOT allowing inbound return traffic on ephemeral ports for HTTP/HTTPS!
  # This is the issue - outbound requests go out but responses can't come back

  Lab4SubnetNetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref Lab4Subnet
      NetworkAclId: !Ref Lab4NetworkAcl

  Lab4SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: Lab4-NACLBlocking-SG
      GroupDescription: Security group for Lab 4
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: 'SSH access'
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: 'All outbound traffic'
      Tags:
        - Key: Name
          Value: Lab4-NACLBlocking-SG
        - Key: Lab
          Value: Lab4-NACLBlocking
        - Key: Auto-delete
          Value: 'no'

  Lab4Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro
      ImageId: !Ref LatestAmiId
      SubnetId: !Ref Lab4Subnet
      SecurityGroupIds:
        - !Ref Lab4SecurityGroup
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y curl wget
          
          cat > /home/ec2-user/test-connectivity.sh << 'EOF'
          #!/bin/bash
          echo "=== Lab 4: NACL Blocking Return Traffic Test ==="
          echo "Testing Internet Connectivity..."
          echo ""
          echo "1. HTTP connectivity (should timeout):"
          curl -I http://google.com --connect-timeout 5
          echo ""
          echo "2. HTTPS connectivity (should timeout):"
          curl -I https://google.com --connect-timeout 5
          echo ""
          echo "Note: Requests go out but responses are blocked by NACL"
          EOF
          
          chmod +x /home/ec2-user/test-connectivity.sh
          chown ec2-user:ec2-user /home/ec2-user/test-connectivity.sh
      Tags:
        - Key: Name
          Value: Lab4-NACLBlocking-Instance
        - Key: Lab
          Value: Lab4-NACLBlocking
        - Key: Issue
          Value: 'NACL blocks inbound return traffic on ephemeral ports'
        - Key: Auto-delete
          Value: 'no'

  # ============================================================================
  # SHARED IAM ROLE FOR ALL INSTANCES
  # ============================================================================
  
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: NetworkTroubleshooting-EC2Role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'
      Tags:
        - Key: Name
          Value: NetworkTroubleshooting-EC2Role
        - Key: Project
          Value: NetworkTroubleshooting
        - Key: Auto-delete
          Value: 'no'

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: NetworkTroubleshooting-InstanceProfile
      Roles:
        - !Ref EC2Role

Outputs:
  VPCId:
    Description: VPC ID for all labs
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VPCId'

  InternetGatewayId:
    Description: Internet Gateway ID
    Value: !Ref InternetGateway
    Export:
      Name: !Sub '${AWS::StackName}-IGWId'

  # Lab 1 Outputs
  Lab1InstanceId:
    Description: 'Lab 1: Missing IGW Route - Instance ID'
    Value: !Ref Lab1Instance
    Export:
      Name: !Sub '${AWS::StackName}-Lab1-InstanceId'

  Lab1SubnetId:
    Description: 'Lab 1: Subnet ID'
    Value: !Ref Lab1Subnet
    Export:
      Name: !Sub '${AWS::StackName}-Lab1-SubnetId'

  Lab1RouteTableId:
    Description: 'Lab 1: Route Table ID (missing IGW route)'
    Value: !Ref Lab1RouteTable
    Export:
      Name: !Sub '${AWS::StackName}-Lab1-RouteTableId'

  Lab1Issue:
    Description: 'Lab 1: Expected Issue'
    Value: 'Route table is missing 0.0.0.0/0 route to Internet Gateway'

  # Lab 2 Outputs
  Lab2InstanceId:
    Description: 'Lab 2: No Public IP - Instance ID'
    Value: !Ref Lab2Instance
    Export:
      Name: !Sub '${AWS::StackName}-Lab2-InstanceId'

  Lab2SubnetId:
    Description: 'Lab 2: Subnet ID'
    Value: !Ref Lab2Subnet
    Export:
      Name: !Sub '${AWS::StackName}-Lab2-SubnetId'

  Lab2Issue:
    Description: 'Lab 2: Expected Issue'
    Value: 'Instance has no public IP address (MapPublicIpOnLaunch is false)'

  # Lab 3 Outputs
  Lab3InstanceId:
    Description: 'Lab 3: Restrictive Security Group - Instance ID'
    Value: !Ref Lab3Instance
    Export:
      Name: !Sub '${AWS::StackName}-Lab3-InstanceId'

  Lab3SecurityGroupId:
    Description: 'Lab 3: Security Group ID (only allows HTTPS)'
    Value: !Ref Lab3SecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-Lab3-SecurityGroupId'

  Lab3Issue:
    Description: 'Lab 3: Expected Issue'
    Value: 'Security group only allows HTTPS (443) egress, blocks HTTP (80)'

  # Lab 4 Outputs
  Lab4InstanceId:
    Description: 'Lab 4: NACL Blocking - Instance ID'
    Value: !Ref Lab4Instance
    Export:
      Name: !Sub '${AWS::StackName}-Lab4-InstanceId'

  Lab4NetworkAclId:
    Description: 'Lab 4: Network ACL ID (blocks return traffic)'
    Value: !Ref Lab4NetworkAcl
    Export:
      Name: !Sub '${AWS::StackName}-Lab4-NetworkAclId'

  Lab4Issue:
    Description: 'Lab 4: Expected Issue'
    Value: 'NACL blocks inbound return traffic on ephemeral ports (1024-65535)'

  # Test Commands
  TestLab1Command:
    Description: 'Command to test Lab 1 with agent'
    Value: !Sub |
      agentcore invoke '{"prompt": "My EC2 instance ${Lab1Instance} cannot connect to the internet. Can you help?", "user_id": "test-user"}'

  TestLab2Command:
    Description: 'Command to test Lab 2 with agent'
    Value: !Sub |
      agentcore invoke '{"prompt": "My EC2 instance ${Lab2Instance} cannot connect to the internet. Can you help?", "user_id": "test-user"}'

  TestLab3Command:
    Description: 'Command to test Lab 3 with agent'
    Value: !Sub |
      agentcore invoke '{"prompt": "My EC2 instance ${Lab3Instance} can access HTTPS but not HTTP. Can you help?", "user_id": "test-user"}'

  TestLab4Command:
    Description: 'Command to test Lab 4 with agent'
    Value: !Sub |
      agentcore invoke '{"prompt": "My EC2 instance ${Lab4Instance} times out when trying to connect to the internet. Can you help?", "user_id": "test-user"}'
